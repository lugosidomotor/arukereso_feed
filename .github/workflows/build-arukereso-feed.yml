name: Build Árukereső feed

on:
  schedule:
    # napi 2x: 04:00 és 16:00 UTC
    - cron: "0 4,16 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build-feed:
    runs-on: ubuntu-latest
    env:
      SOURCE_URL: "https://artpresident.hu/wp-content/uploads/woo-product-feed-pro/xml/AdVpZenPL5fxCKWoqd0N65WyCSSRZ2Kd.xml"
      VAT_FACTOR: "1.27"
      OUTPUT_FILE: "arukereso_feed.xml"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Download source XML
        run: |
          curl -fsSL "$SOURCE_URL" -o source.xml

      - name: Transform net_price values (÷1.27, round to int, preserve formatting)
        shell: bash
        run: |
          cat > transform.py << 'PY'
          import re
          import decimal

          input_file = "source.xml"
          output_file = "arukereso_feed.xml"
          factor = decimal.Decimal("${{ env.VAT_FACTOR }}")
          decimal.getcontext().rounding = decimal.ROUND_HALF_UP

          # read raw text to preserve formatting
          with open(input_file, "r", encoding="utf-8") as f:
              xml_text = f.read()

          def replace_price(match):
              val_str = match.group(1)
              try:
                  val = decimal.Decimal(val_str.strip().replace(",", "."))
                  new_val = (val / factor).quantize(decimal.Decimal("1"))
                  return f"<net_price>{int(new_val)}</net_price>"
              except Exception:
                  return match.group(0)

          # only replace the content inside <net_price>...</net_price>
          updated = re.sub(r"<net_price>(.*?)</net_price>", replace_price, xml_text)

          # write out without changing anything else
          with open(output_file, "w", encoding="utf-8") as f:
              f.write(updated)
          PY

          python3 transform.py

      - name: Configure git author
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Commit and push if changed
        run: |
          git add "${OUTPUT_FILE}"
          if ! git diff --cached --quiet; then
            git commit -m "Update ${OUTPUT_FILE}: net_price ÷ 1.27 (rounded)"
            git push
            echo "Changes pushed."
          else
            echo "No changes to commit."
          fi
